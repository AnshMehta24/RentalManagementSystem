// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  VENDOR
  CUSTOMER
}

enum AddressType {
  BILLING
  SHIPPING
  PICKUP
}

enum FulfillmentType {
  STORE_PICKUP
  DELIVERY
}

enum StaffPermission {
  MANAGE_PRODUCTS
  MANAGE_ORDERS
  MANAGE_PICKUP
  MANAGE_RETURN
  MANAGE_INVOICES
  VIEW_REPORTS
}

enum QuotationStatus {
  DRAFT
  SENT
  CONFIRMED
  CANCELLED
}

enum OrderStatus {
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PARTIALLY_PAID
  PAID
  REFUNDED
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentFor {
  RENT
  SECURITY_DEPOSIT
  DELIVERY_CHARGE
}

enum StockStatus {
  AVAILABLE
  RESERVED
  WITH_CUSTOMER
}

enum CouponType {
  FLAT
  PERCENTAGE
}

enum NotificationType {
  RETURN_REMINDER
  LATE_ALERT
  PAYMENT_CONFIRMATION
}


enum PeriodUnit {
  HOUR
  DAY
  WEEK
  MONTH
  YEAR
}

enum AttributeDisplayType {
  RADIO
  PILLS
  CHECKBOX
  IMAGE
}

model User {
  id   Int      @id @default(autoincrement())
  role UserRole

  profileLogo String?
  name        String
  email       String  @unique
  password    String

  companyName String?
  companyLogo String?
  gstin       String?

  stripeCustomerId String?

  addresses Address[]
  deliveryConfig VendorDeliveryConfig?

  quotations Quotation[]   @relation("CustomerQuotations")
  orders     RentalOrder[] @relation("CustomerOrders")

  products   Product[]     @relation("VendorProducts")
  staff      VendorStaff[] @relation("VendorOwner")
  employedAt VendorStaff[] @relation("VendorStaff")

  notifications Notification[]
  activities    ActivityLog[]
  quotationPaymentLinkLogsSent QuotationPaymentLinkLog[]

  tokens     UserToken[] 
  wishlistItems WishlistItem[]

  invoices   Invoice[]
  pickups    Pickup[]
  deliveries Delivery[]
  returns    Return[]
  cart       Cart?

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  vendorQuotations Quotation[] @relation("VendorQuotations")
}

model Address {
  id     Int         @id @default(autoincrement())
  userId Int
  type   AddressType

  name    String?
  line1   String
  line2   String?
  city    String
  state   String
  country String
  pincode String

  isDefault Boolean @default(false)

  user                User         @relation(fields: [userId], references: [id])
  deliveryQuotations  Quotation[]  @relation("DeliveryAddress")
  billingQuotations   Quotation[]  @relation("BillingAddress")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VendorStaff {
  id       Int @id @default(autoincrement())
  vendorId Int
  staffId  Int

  permissions StaffPermission[]
  isActive    Boolean           @default(true)

  vendor User @relation("VendorOwner", fields: [vendorId], references: [id])
  staff  User @relation("VendorStaff", fields: [staffId], references: [id])

  createdAt DateTime @default(now())

  @@unique([vendorId, staffId])
}

model Attribute {
  id          Int                  @id @default(autoincrement())
  name        String               @unique
  displayType AttributeDisplayType
  isActive    Boolean              @default(true)

  values                 AttributeValue[]
  variantAttributeValues VariantAttributeValue[]
}

model AttributeValue {
  id          Int     @id @default(autoincrement())
  attributeId Int
  value       String
  extraPrice  Float   @default(0)
  isActive    Boolean @default(true)

  attribute              Attribute               @relation(fields: [attributeId], references: [id])
  variantAttributeValues VariantAttributeValue[]

  @@unique([attributeId, value])
}

model Product {
  id       Int @id @default(autoincrement())
  vendorId Int

  name        String
  description String?
  imageUrl    String?
  isRentable  Boolean @default(true)
  published   Boolean @default(true)

  vendor   User             @relation("VendorProducts", fields: [vendorId], references: [id])
  variants ProductVariant[]
  wishlistItems WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductVariant {
  id        Int @id @default(autoincrement())
  productId Int

  sku       String?
  quantity  Int
  costPrice Float
  salePrice Float

  product Product @relation(fields: [productId], references: [id])

  attributes   VariantAttributeValue[]
  prices       RentalPrice[]
  reservations Reservation[]
  inventory    InventoryLog[]

  quotationItems QuotationItem[]
  orderItems     OrderItem[]
  cartItems      CartItem[]
}

model VariantAttributeValue {
  id               Int @id @default(autoincrement())
  variantId        Int
  attributeId      Int
  attributeValueId Int

  variant   ProductVariant @relation(fields: [variantId], references: [id])
  attribute Attribute      @relation(fields: [attributeId], references: [id])
  value     AttributeValue @relation(fields: [attributeValueId], references: [id])

  @@unique([variantId, attributeId])
}

model RentalPeriod {
  id       Int           @id @default(autoincrement())
  name     String
  duration Int
  unit     PeriodUnit
  isActive Boolean    @default(true)

  rentalPrices RentalPrice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([duration, unit])
}

model RentalPrice {
  id        Int   @id @default(autoincrement())
  variantId Int
  periodId  Int
  price     Float

  variant ProductVariant @relation(fields: [variantId], references: [id])
  period  RentalPeriod   @relation(fields: [periodId], references: [id])

  @@unique([variantId, periodId])
}

model Coupon {
  id          Int        @id @default(autoincrement())
  code        String     @unique
  type        CouponType
  value       Float
  maxDiscount Float?
  validFrom   DateTime
  validTill   DateTime
  isActive    Boolean    @default(true)

  quotations Quotation[]
  createdAt  DateTime    @default(now())
}

model Quotation {
  id         Int @id @default(autoincrement())

  customerId Int
  vendorId   Int

  customer User @relation("CustomerQuotations", fields: [customerId], references: [id])
  vendor   User @relation("VendorQuotations", fields: [vendorId], references: [id])

  status QuotationStatus @default(DRAFT)

  couponId Int?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  deliveryAddressId Int?
  billingAddressId  Int?

  fulfillmentType FulfillmentType?
  deliveryCharge  Float? @default(0)

  deliveryAddress Address? @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  billingAddress  Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])

  items QuotationItem[]
  order RentalOrder?
  paymentLinkLogs QuotationPaymentLinkLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuotationItem {
  id          Int @id @default(autoincrement())
  quotationId Int
  variantId   Int

  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  price       Float

  quotation Quotation      @relation(fields: [quotationId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])
}

model WishlistItem {
  id        Int @id @default(autoincrement())
  userId    Int
  productId Int
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model Cart {
  id         Int       @id @default(autoincrement())
  customerId Int       @unique
  customer   User       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items      CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id          Int      @id @default(autoincrement())
  cartId      Int
  variantId   Int
  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  price       Float

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, variantId, rentalStart, rentalEnd])
}

model RentalOrder {
  id          Int @id @default(autoincrement())
  quotationId Int @unique
  customerId  Int

  status          OrderStatus     @default(CONFIRMED)
  fulfillmentType FulfillmentType

  pickupAddressId   Int?
  deliveryAddressId Int?

  deliveryCharge Float   @default(0)
  couponCode     String?
  discountAmt    Float   @default(0)

  customer  User      @relation("CustomerOrders", fields: [customerId], references: [id])
  quotation Quotation @relation(fields: [quotationId], references: [id])

  items        OrderItem[]
  reservations Reservation[]
  invoice      Invoice?
  pickup       Pickup?
  delivery     Delivery?
  return       Return?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        Int @id @default(autoincrement())
  orderId   Int
  variantId Int

  quantity    Int
  rentalStart DateTime
  rentalEnd   DateTime
  price       Float

  order   RentalOrder    @relation(fields: [orderId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])
}

model Reservation {
  id        Int @id @default(autoincrement())
  variantId Int
  orderId   Int

  startDate    DateTime
  endDate      DateTime
  quantity     Int
  availableQty Int
  status       StockStatus @default(RESERVED)

  variant ProductVariant @relation(fields: [variantId], references: [id])
  order   RentalOrder    @relation(fields: [orderId], references: [id])

  @@index([variantId, startDate, endDate])
}

model InventoryLog {
  id        Int  @id @default(autoincrement())
  variantId Int
  orderId   Int?

  changeQty Int
  reason    String

  variant ProductVariant @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now())
}

model Invoice {
  id              Int @id @default(autoincrement())
  orderId         Int @unique
  createdByUserId Int

  rentalAmount    Float
  securityDeposit Float
  deliveryCharge  Float
  totalAmount     Float
  paidAmount      Float @default(0)

  status InvoiceStatus @default(DRAFT)

  order     RentalOrder @relation(fields: [orderId], references: [id])
  createdBy User        @relation(fields: [createdByUserId], references: [id])
  payments  Payment[]

  createdAt DateTime @default(now())
}

model Payment {
  id        Int @id @default(autoincrement())
  invoiceId Int

  amount Float
  for    PaymentFor
  status PaymentStatus

  stripePaymentIntentId   String  @unique
  stripeCheckoutSessionId String
  stripeRefundId          String?

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now())
}

model Pickup {
  id              Int      @id @default(autoincrement())
  orderId         Int      @unique
  handledByUserId Int
  pickedAt        DateTime @default(now())

  order     RentalOrder @relation(fields: [orderId], references: [id])
  handledBy User        @relation(fields: [handledByUserId], references: [id])
}

model Delivery {
  id              Int  @id @default(autoincrement())
  orderId         Int  @unique
  handledByUserId Int?

  shippedAt      DateTime?
  deliveredAt    DateTime?
  deliveryCharge Float     @default(0)

  order     RentalOrder @relation(fields: [orderId], references: [id])
  handledBy User?       @relation(fields: [handledByUserId], references: [id])
}

model Return {
  id              Int @id @default(autoincrement())
  orderId         Int @unique
  handledByUserId Int

  returnedAt      DateTime
  lateFee         Float    @default(0)
  damageFee       Float    @default(0)
  depositRefunded Float    @default(0)

  order     RentalOrder @relation(fields: [orderId], references: [id])
  handledBy User        @relation(fields: [handledByUserId], references: [id])
}

model Notification {
  id      Int              @id @default(autoincrement())
  userId  Int
  type    NotificationType
  message String
  isRead  Boolean          @default(false)

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model ActivityLog {
  id       Int    @id @default(autoincrement())
  userId   Int?
  action   String
  entity   String
  entityId Int?

  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model QuotationPaymentLinkLog {
  id           Int      @id @default(autoincrement())
  quotationId  Int
  checkoutUrl  String
  sentToEmail  String
  sentByUserId Int?

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  sentBy    User?     @relation(fields: [sentByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([quotationId])
}

model VendorDeliveryConfig {
  id                Int @id @default(autoincrement())
  vendorId          Int

  isDeliveryEnabled Boolean @default(true)

  chargeType        DeliveryChargeType

  flatCharge        Float?  
  ratePerKm         Float?   
  freeAboveAmount   Float?  

  maxDeliveryKm     Float?   

  vendor            User @relation(fields: [vendorId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([vendorId])
}

enum DeliveryChargeType {
  FLAT
  PER_KM
  FREE
}

model UserToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  userType  String   @map("user_type")
  purpose   String
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_tokens")
}